<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Fiber (picos.Picos.Fiber)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">picos</a> &#x00BB; <a href="../index.html">Picos</a> &#x00BB; Fiber</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Picos.Fiber</span></code></h1><p>An independent thread of execution.</p><p>A fiber corresponds to an independent thread of execution. Fibers are <a href="#val-create"><code>create</code></a>d by schedulers in response to <a href="#extension-Spawn"><code>Spawn</code></a> effects. A fiber is associated with a <a href="../Computation/index.html" title="Computation">computation</a> and either <a href="#val-forbid"><code>forbid</code></a>s or <a href="#val-permit"><code>permit</code></a>s the scheduler from propagating cancelation to it. A fiber also has an associated <a href="FLS/index.html" title="FLS">fiber local storage</a>.</p><p>‚ö†Ô∏è Many operations on fibers can only be called safely from the fiber itself, because those operations are neither concurrency nor parallelism safe. Such operations can be safely called from a handler in a scheduler when it is handling an effect performed by the fiber. In particular, a scheduler can safely check whether the fiber <a href="#val-has_forbidden"><code>has_forbidden</code></a> cancelation and may access the <a href="FLS/index.html"><code>FLS</code></a> of the fiber.</p></header><nav class="odoc-toc"><ul><li><a href="#interface-for-rescheduling">Interface for rescheduling</a></li><li><a href="#interface-for-spawning">Interface for spawning</a></li><li><a href="#interface-for-current-fiber">Interface for current fiber</a></li><li><a href="#interface-for-foreign-fiber">Interface for foreign fiber</a></li><li><a href="#interface-for-schedulers">Interface for schedulers</a></li><li><a href="#design-rationale">Design rationale</a></li></ul></nav><div class="odoc-content"><h3 id="interface-for-rescheduling"><a href="#interface-for-rescheduling" class="anchor"></a>Interface for rescheduling</h3><div class="odoc-spec"><div class="spec value anchored" id="val-yield"><a href="#val-yield" class="anchor"></a><code><span><span class="keyword">val</span> yield : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>yield ()</code> asks the current fiber to be re-scheduled.</p><p>‚ÑπÔ∏è The behavior is that</p><ul><li>on OCaml 5, <code>yield</code> perform the <a href="#extension-Yield"><code>Yield</code></a> effect, and</li><li>on OCaml 4, <code>yield</code> will next call <a href="#val-current"><code>Fiber.current</code></a> and will finally call the <a href="../module-type-Implementation/Fiber/index.html#val-yield" title="Implementation.Fiber.yield"><code>yield</code> operation</a> of the <a href="../index.html#val-set_picos_implementation" title="set_picos_implementation">implementation</a>.</li></ul></div></div><h3 id="interface-for-spawning"><a href="#interface-for-spawning" class="anchor"></a>Interface for spawning</h3><div class="odoc-spec"><div class="spec value anchored" id="val-spawn"><a href="#val-spawn" class="anchor"></a><code><span><span class="keyword">val</span> spawn : <span><span class="label">forbid</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../Computation/index.html#type-t">Computation.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> list</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>spawn ~forbid computation mains</code> starts new fibers by performing the <a href="#extension-Spawn"><code>Spawn</code></a> effect. The fibers will share the same <code>computation</code> and start with <a href="#val-has_forbidden" title="Fiber.has_forbidden">propagation of cancelation forbidden or permitted</a> depending on the <code>forbid</code> flag.</p><p>‚ÑπÔ∏è Any <a href="../Computation/index.html" title="Computation">computation</a>, including the computation of the current fiber, may be passed as the computation for new fibers. Higher level libraries are free to implement the desired structuring principles.</p><p>‚ö†Ô∏è Behavior is undefined if any function in <code>mains</code> raises an exception. For example, raising an exception might terminate the whole application (recommended, but not required) or the exception might be ignored. In other words, the caller <i>must</i> arrange for the computation to be completed and errors reported in a desired manner.</p><p>‚ÑπÔ∏è The behavior is that</p><ul><li>on OCaml 5, <code>spawn</code> performs the <a href="#extension-Spawn"><code>Spawn</code></a> effect, and</li><li>on OCaml 4, <code>spawn</code> will next call <a href="#val-current"><code>Fiber.current</code></a> and will finally call the <a href="../module-type-Implementation/Fiber/index.html#val-spawn" title="Implementation.Fiber.spawn"><code>spawn</code> operation</a> of the <a href="../index.html#val-set_picos_implementation" title="set_picos_implementation">implementation</a>.</li></ul></div></div><h3 id="interface-for-current-fiber"><a href="#interface-for-current-fiber" class="anchor"></a>Interface for current fiber</h3><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Represents a fiber or an independent thread of execution.</p><p>‚ö†Ô∏è Unlike with most other concepts of Picos, operations on fibers are typically <i>not</i> concurrency or parallelism safe, because the fiber is considered to be owned by a single thread of execution.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-current"><a href="#val-current" class="anchor"></a><code><span><span class="keyword">val</span> current : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>current ()</code> returns the current fiber.</p><p>‚ö†Ô∏è Extra care should be taken when storing the fiber object in any shared data structure, because, aside from checking whether two fibers are <a href="#val-equal"><code>equal</code></a>, or from accessing the associated <a href="#val-computation"><code>computation</code></a>, it is generally unsafe to perform any operations on foreign fibers.</p><p>‚ÑπÔ∏è The behavior is that</p><ul><li>on OCaml 5, <code>current</code> performs the <a href="#extension-Current"><code>Current</code></a> effect, and</li><li>on OCaml 4, <code>current</code> will call the <a href="../module-type-Implementation/Fiber/index.html#val-current" title="Implementation.Fiber.current"><code>current</code> operation</a> of the <a href="../index.html#val-set_picos_implementation" title="set_picos_implementation">implementation</a>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-has_forbidden"><a href="#val-has_forbidden" class="anchor"></a><code><span><span class="keyword">val</span> has_forbidden : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>has_forbidden fiber</code> determines whether the fiber <a href="#val-forbid"><code>forbid</code></a>s or <a href="#val-permit"><code>permit</code></a>s the scheduler from propagating cancelation to it.</p><p>‚ÑπÔ∏è This is mostly useful in the effect handlers of schedulers.</p><p>‚ö†Ô∏è There is no &quot;reference count&quot; of how many times a fiber has forbidden or permitted propagation of cancelation. Calls to <a href="#val-forbid"><code>forbid</code></a> and <a href="#val-permit"><code>permit</code></a> directly change a single boolean flag.</p><p>‚ö†Ô∏è It is only safe to call <code>has_forbidden</code> from the fiber itself.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-forbid"><a href="#val-forbid" class="anchor"></a><code><span><span class="keyword">val</span> forbid : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>forbid fiber thunk</code> tells the scheduler that cancelation must not be propagated to the fiber during the execution of <code>thunk</code>.</p><p>The main use case of <code>forbid</code> is the implementation of concurrent abstractions that may have to <a href="../Trigger/index.html#val-await" title="Trigger.await">await</a> for something, or may need to perform other effects, and must not be canceled while doing so. For example, the wait operation on a condition variable typically re-acquires the associated mutex before returning, which may require awaiting for the owner of the mutex to release it.</p><p>‚ÑπÔ∏è <code>forbid</code> does not prevent the fiber or the associated <a href="#val-computation"><code>computation</code></a> from being canceled. It only tells the scheduler not to propagate cancelation to the fiber.</p><p>‚ö†Ô∏è It is only safe to call <code>forbid</code> from the fiber itself.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-permit"><a href="#val-permit" class="anchor"></a><code><span><span class="keyword">val</span> permit : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>permit fiber thunk</code> tells the scheduler that cancelation may be propagated to the fiber during the execution of <code>thunk</code>.</p><p>It is possible to <a href="#val-spawn"><code>spawn</code></a> a fiber with cancelation forbidden, which means that cancelation won't be propagated to fiber unless it is explicitly <a href="#val-permit" title="permit">permitted</a> by the fiber at some point.</p><p>‚ö†Ô∏è It is only safe to call <code>permit</code> from the fiber itself.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-canceled"><a href="#val-canceled" class="anchor"></a><code><span><span class="keyword">val</span> canceled : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../Picos_exn_bt/index.html#type-t">Exn_bt.t</a> option</span></span></code></div><div class="spec-doc"><p><code>canceled fiber</code> is equivalent to:</p><pre class="language-ocaml"><code>if Fiber.has_forbidden fiber then
  None
else
  let (Packed computation) =
    Fiber.computation fiber
  in
  Computation.canceled computation</code></pre><p>‚ÑπÔ∏è This is mostly useful in the effect handlers of schedulers.</p><p>‚ö†Ô∏è It is only safe to call <code>canceled</code> from the fiber itself.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check"><a href="#val-check" class="anchor"></a><code><span><span class="keyword">val</span> check : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>check fiber</code> is equivalent to:</p><pre class="language-ocaml"><code>if not (Fiber.has_forbidden fiber) then
  let (Packed computation) =
    Fiber.computation fiber
  in
  Computation.check computation</code></pre><p>‚ÑπÔ∏è This is mostly useful for periodically polling the cancelation status during CPU intensive work.</p><p>‚ö†Ô∏è It is only safe to call <code>check</code> from the fiber itself.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-FLS"><a href="#module-FLS" class="anchor"></a><code><span><span class="keyword">module</span> <a href="FLS/index.html">FLS</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Fiber local storage</p></div></div><h3 id="interface-for-foreign-fiber"><a href="#interface-for-foreign-fiber" class="anchor"></a>Interface for foreign fiber</h3><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>equal fiber1 fiber2</code> determines whether <code>fiber1</code> and <code>fiber2</code> are one and the same fiber.</p><p>‚ÑπÔ∏è One use case of <code>equal</code> is in the implementation of concurrent primitives like mutexes where it makes sense to check that acquire and release operations are performed by the same fiber.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-computation"><a href="#val-computation" class="anchor"></a><code><span><span class="keyword">val</span> computation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Computation/index.html#type-packed">Computation.packed</a></span></code></div><div class="spec-doc"><p><code>computation fiber</code> returns the computation that the fiber has been <a href="#val-create"><code>create</code></a>d with.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_attach"><a href="#val-try_attach" class="anchor"></a><code><span><span class="keyword">val</span> try_attach : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Trigger/index.html#type-t">Trigger.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_attach fiber trigger</code> is equivalent to <code>let Packed c = computation fiber in Computation.try_attach c trigger</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-detach"><a href="#val-detach" class="anchor"></a><code><span><span class="keyword">val</span> detach : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Trigger/index.html#type-t">Trigger.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>detach fiber trigger</code> is equivalent to <code>let Packed c = computation fiber in Computation.detach c trigger</code>.</p></div></div><h3 id="interface-for-schedulers"><a href="#interface-for-schedulers" class="anchor"></a>Interface for schedulers</h3><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><span class="label">forbid</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../Computation/index.html#type-t">Computation.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~forbid computation</code> creates a new fiber.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-continue"><a href="#val-continue" class="anchor"></a><code><span><span class="keyword">val</span> continue : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'v</span>, <span class="type-var">'r</span>)</span> <span class="xref-unresolved">Stdlib</span>.Effect.Deep.continuation</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>continue fiber k v</code> is equivalent to:</p><pre class="language-ocaml"><code>match Fiber.canceled fiber with
| None -&gt; Effect.Deep.continue k v
| Some exn_bt -&gt; Exn_bt.discontinue k exn_bt</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-continue_with"><a href="#val-continue_with" class="anchor"></a><code><span><span class="keyword">val</span> continue_with : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'v</span>, <span class="type-var">'b</span>)</span> <span class="xref-unresolved">Stdlib</span>.Effect.Shallow.continuation</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="type-var">'b</span>, <span class="type-var">'r</span>)</span> <span class="xref-unresolved">Stdlib</span>.Effect.Shallow.handler</span> <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'r</span></span></code></div><div class="spec-doc"><p><code>continue_with fiber k v h</code> is equivalent to:</p><pre class="language-ocaml"><code>match Fiber.canceled fiber with
| None -&gt; Effect.Shallow.continue_with k v h
| Some exn_bt -&gt; Exn_bt.discontinue_with k exn_bt h</code></pre></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Current"><a href="#extension-decl-Current" class="anchor"></a><code><span><span class="keyword">type</span> <span class="xref-unresolved">Stdlib</span>.Effect.t += <span class="keyword">private</span> </span></code><ol><li id="extension-Current" class="def variant extension anchored"><a href="#extension-Current" class="anchor"></a><code><span>| </span><span><span class="extension">Current</span> : <span><a href="#type-t">t</a> <span class="xref-unresolved">Stdlib</span>.Effect.t</span></span></code></li></ol></div><div class="spec-doc"><p>Schedulers may handle the <a href="#extension-Current"><code>Current</code></a> effect to customize the behavior of <code>current</code>.</p><p>A handler should eventually either continue the fiber or discontinue it in case the fiber permits propagation of cancelation and the associated computation has been canceled.</p><p>Note that in typical use cases of <code>current</code> it makes sense to give priority to the fiber performing <a href="#extension-Current"><code>Current</code></a>, but this is not required.</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Yield"><a href="#extension-decl-Yield" class="anchor"></a><code><span><span class="keyword">type</span> <span class="xref-unresolved">Stdlib</span>.Effect.t += <span class="keyword">private</span> </span></code><ol><li id="extension-Yield" class="def variant extension anchored"><a href="#extension-Yield" class="anchor"></a><code><span>| </span><span><span class="extension">Yield</span> : <span>unit <span class="xref-unresolved">Stdlib</span>.Effect.t</span></span></code></li></ol></div><div class="spec-doc"><p>Schedulers may handle the <a href="#extension-Yield"><code>Yield</code></a> effect to customize the behavior of <code>yield</code>.</p><p>Just like with <a href="#extension-Current"><code>Current</code></a>, a handler should either continue or discontinue the fiber, but, unlike with <a href="#extension-Current"><code>Current</code></a>, the scheduler should give priority to running other ready fibers before resuming the fiber performing <a href="#extension-Yield"><code>Yield</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Spawn"><a href="#extension-decl-Spawn" class="anchor"></a><code><span><span class="keyword">type</span> <span class="xref-unresolved">Stdlib</span>.Effect.t += <span class="keyword">private</span> </span></code><ol><li id="extension-Spawn" class="def variant extension anchored"><a href="#extension-Spawn" class="anchor"></a><code><span>| </span><span><span class="extension">Spawn</span> : </span><span>{</span></code><ol><li id="module-Fiber.forbid" class="def record field anchored"><a href="#module-Fiber.forbid" class="anchor"></a><code><span>forbid : bool;</span></code></li><li id="module-Fiber.computation" class="def record field anchored"><a href="#module-Fiber.computation" class="anchor"></a><code><span>computation : <span><span class="type-var">'a</span> <a href="../Computation/index.html#type-t">Computation.t</a></span>;</span></code></li><li id="module-Fiber.mains" class="def record field anchored"><a href="#module-Fiber.mains" class="anchor"></a><code><span>mains : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> list</span>;</span></code></li></ol><code><span>}</span><span> <span class="arrow">&#45;&gt;</span> <span>unit <span class="xref-unresolved">Stdlib</span>.Effect.t</span></span></code></li></ol></div><div class="spec-doc"><p>Schedulers may handle the <a href="#extension-Spawn"><code>Spawn</code></a> effect to customize the behavior of <code>spawn</code>.</p><p>The scheduler is free to run the newly created fibers on any domain and decide which fiber to give priority to.</p></div></div><h3 id="design-rationale"><a href="#design-rationale" class="anchor"></a>Design rationale</h3><p>The idea is that fibers correspond 1-to-1 with independent threads of execution. This allows a fiber to non-atomically store state related to a thread of execution.</p><p>The status of whether propagation of cancelation is forbidden or permitted could be stored in the <a href="FLS/index.html" title="FLS">fiber local storage</a>. The justification for storing it directly with the fiber is that the implementation of some key synchronization and communication mechanisms, such as condition variables, requires the capability.</p><p>No integer fiber id is provided by default. It would seem that for most intents and purposes the identity of the fiber is sufficient. <a href="FLS/index.html" title="FLS">Fiber local storage</a> can be used to implement a fiber id or e.g. a fiber hash.</p><p>The <a href="FLS/index.html" title="FLS">fiber local storage</a> is designed for the purpose of extending fibers and to be as fast as possible. It is not intended for application programming.</p><p><a href="#extension-Yield"><code>Yield</code></a> is provided as a separate effect to specifically communicate the intent that the current fiber should be rescheduled. This allows all the other effect handlers more freedom in choosing which fiber to schedule next.</p></div></body></html>
